{% extends "base.html" %}

{% block title %}Reports - SmartRetail AI{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
                <div class="card-header" style="background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);">
                    <h4 class="mb-0 text-white">Reports</h4>
                </div>
                <div class="card-body">
                    <!-- Report List -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>Schedule</th>
                                    <th>Last Generated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reportsList">
                                <!-- Reports will be loaded here dynamically -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Create Report Button -->
                    <button class="btn btn-primary mt-3" style="background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);" data-bs-toggle="modal" data-bs-target="#createReportModal">
                        <i class="fas fa-plus"></i> Create New Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Report Modal -->
<div class="modal fade" id="createReportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);">
                <h5 class="modal-title text-white">Create New Report</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createReportForm">
                    <div class="mb-3">
                        <label for="reportTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="reportTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="reportType" class="form-label">Type</label>
                        <select class="form-select" id="reportType" required>
                            <option value="sales">Sales Report</option>
                            <option value="inventory">Inventory Report</option>
                            <option value="expense">Expense Report</option>
                            <option value="custom">Custom Report</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reportSchedule" class="form-label">Schedule</label>
                        <select class="form-select" id="reportSchedule">
                            <option value="none">No Schedule</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <div id="reportParameters" class="mb-3">
                        <!-- Parameters will be loaded dynamically based on report type -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" style="background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);" onclick="createReport()">Create Report</button>
            </div>
        </div>
    </div>
</div>

<!-- Generate Report Modal -->
<div class="modal fade" id="generateReportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);">
                <h5 class="modal-title text-white">Generate Report</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="generateReportForm">
                    <div id="generateReportParameters">
                        <!-- Parameters will be loaded dynamically based on report type -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" style="background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);" onclick="generateReport()">Generate</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load reports on page load
document.addEventListener('DOMContentLoaded', function() {
    loadReports();
});

// Load reports from API
function loadReports() {
    fetch('/report/api/reports')
        .then(response => response.json())
        .then(reports => {
            const reportsList = document.getElementById('reportsList');
            reportsList.innerHTML = '';
            
            reports.forEach(report => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${report.title}</td>
                    <td>${report.type}</td>
                    <td>${report.schedule}</td>
                    <td>${report.last_generated ? new Date(report.last_generated).toLocaleString() : 'Never'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-2" onclick="showGenerateReportModal(${report.id})" style="background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);">
                            <i class="fas fa-file-alt"></i> Generate
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteReport(${report.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                reportsList.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error loading reports:', error);
            showAlert('Error loading reports', 'danger');
        });
}

// Create new report
function createReport() {
    const title = document.getElementById('reportTitle').value;
    const type = document.getElementById('reportType').value;
    const schedule = document.getElementById('reportSchedule').value;
    const parameters = getReportParameters();

    fetch('/report/api/reports', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title,
            type,
            schedule,
            parameters
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        $('#createReportModal').modal('hide');
        loadReports();
        showAlert('Report created successfully', 'success');
    })
    .catch(error => {
        console.error('Error creating report:', error);
        showAlert('Error creating report', 'danger');
    });
}

// Generate report
function generateReport() {
    const reportId = document.getElementById('generateReportForm').dataset.reportId;
    const parameters = getGenerateReportParameters();

    fetch(`/report/api/reports/${reportId}/generate`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ parameters })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        $('#generateReportModal').modal('hide');
        loadReports();
        showAlert('Report generation started', 'success');
    })
    .catch(error => {
        console.error('Error generating report:', error);
        showAlert('Error generating report', 'danger');
    });
}

// Delete report
function deleteReport(reportId) {
    if (!confirm('Are you sure you want to delete this report?')) {
        return;
    }

    fetch(`/report/api/reports/${reportId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        loadReports();
        showAlert('Report deleted successfully', 'success');
    })
    .catch(error => {
        console.error('Error deleting report:', error);
        showAlert('Error deleting report', 'danger');
    });
}

// Show generate report modal
function showGenerateReportModal(reportId) {
    const form = document.getElementById('generateReportForm');
    form.dataset.reportId = reportId;
    $('#generateReportModal').modal('show');
}

// Get report parameters based on type
function getReportParameters() {
    const type = document.getElementById('reportType').value;
    const parameters = {};

    switch (type) {
        case 'sales':
            parameters.dateRange = document.getElementById('salesDateRange').value;
            parameters.groupBy = document.getElementById('salesGroupBy').value;
            break;
        case 'inventory':
            parameters.lowStock = document.getElementById('inventoryLowStock').checked;
            parameters.category = document.getElementById('inventoryCategory').value;
            break;
        case 'expense':
            parameters.dateRange = document.getElementById('expenseDateRange').value;
            parameters.category = document.getElementById('expenseCategory').value;
            break;
        case 'custom':
            parameters.query = document.getElementById('customQuery').value;
            break;
    }

    return parameters;
}

// Get generate report parameters
function getGenerateReportParameters() {
    const form = document.getElementById('generateReportForm');
    const parameters = {};
    
    // Get all form inputs
    const inputs = form.querySelectorAll('input, select');
    inputs.forEach(input => {
        if (input.type === 'checkbox') {
            parameters[input.id] = input.checked;
        } else {
            parameters[input.id] = input.value;
        }
    });

    return parameters;
}

// Show alert message
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.row'));
    setTimeout(() => alertDiv.remove(), 5000);
}
</script>
{% endblock %}
